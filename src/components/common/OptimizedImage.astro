---
import { Image } from 'astro:assets';
import { resolveImage } from '~/utils/image-loader';
import { getImageUrl } from '~/utils/supabase-images';

export interface Props {
  src: any;
  alt: string;
  title?: string;
  width?: number;
  height?: number;
  loading?: 'lazy' | 'eager';
  decoding?: 'async' | 'auto' | 'sync';
  fetchpriority?: 'high' | 'low' | 'auto';
  class?: string;
  format?: 'avif' | 'webp' | 'png' | 'jpg';
  quality?: number;
  inferSize?: boolean;
}

const {
  src: _src,
  alt,
  title,
  width,
  height,
  loading = 'lazy',
  decoding = 'async',
  fetchpriority = 'auto',
  class: className = '',
  format = 'webp',
  quality = 80,
  inferSize = true,
  ...rest
} = Astro.props;

// Resolve the image (handles Supabase paths, local paths, etc.)
const src = await resolveImage(_src);

// Validate alt text exists and is meaningful
if (!alt || alt.trim() === '') {
  console.warn(`Image missing alt text: ${_src}`);
}
---

{typeof src === 'string' ? (
  <!-- Use regular img tag for Supabase/remote images -->
  <img
    src={getImageUrl(src)}
    alt={alt}
    {title}
    {width}
    {height}
    loading={loading}
    decoding={decoding}
    class={className}
    {...rest}
  />
) : (
  <!-- Use Astro Image component for local images -->
  <Image
    src={src}
    alt={alt}
    {title}
    {width}
    {height}
    {loading}
    {decoding}
    {fetchpriority}
    {format}
    {quality}
    inferSize={inferSize}
    class={className}
    {...rest}
  />
)}
