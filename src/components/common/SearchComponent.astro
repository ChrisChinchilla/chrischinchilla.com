---
interface Post {
  url: string;
  title: string;
  description: string;
  //image?: string;
  publishDate?: string;
  tags?: string[];
}

interface Props {
  posts: Post[];
}

const { posts } = Astro.props;
---

<!-- Search trigger button -->
<button
  type="button"
  class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5 inline-flex items-center"
  aria-label="Search site content"
  id="search-trigger"
>
  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
  </svg>
</button>

<!-- Search modal -->
<div id="search-modal" class="search-modal hidden">
  <!-- Overlay -->
  <div class="search-modal-overlay" id="search-overlay"></div>

  <!-- Modal content -->
  <div 
    class="search-modal-content"
    role="dialog"
    aria-modal="true"
    aria-labelledby="search-modal-title"
    tabindex="-1"
  >
    <div class="search-modal-header">
      <h2 id="search-modal-title" class="sr-only">Search Posts</h2>
      <button
        type="button"
        class="search-modal-close"
        aria-label="Close search"
        id="search-close"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Search input -->
    <div class="search-input-container">
      <input
        type="text"
        class="search-input"
        placeholder="Search posts..."
        id="search-input"
      />
    </div>

    <!-- Search results - rendered dynamically -->
    <div class="search-results-container" id="search-results">
      <div class="search-placeholder" id="search-placeholder">
        Start typing to search posts...
      </div>

      <div class="search-no-results hidden" id="search-no-results">
        No results found
      </div>

      <div class="search-results-grid" id="search-results-grid">
        <!-- Results will be dynamically inserted here -->
      </div>
    </div>
  </div>
</div>

<!-- Pass posts data for Fuse.js searching -->
<script type="application/json" id="search-data" data-posts={JSON.stringify(posts)}></script>

<script>
  import Fuse from 'fuse.js';

  // Get posts from data attribute
  let posts: Post[] = [];
  try {
    const dataElement = document.getElementById('search-data');
    if (dataElement) {
      const postsData = dataElement.getAttribute('data-posts');
      posts = postsData ? JSON.parse(postsData) : [];
    }
  } catch (error) {
    console.error('Failed to parse search data:', error);
    posts = [];
  }

  // Initialize Fuse.js for fuzzy search
  const fuse = new Fuse(posts, {
    keys: ['title', 'description', 'tags'],
    threshold: 0.4,
    minMatchCharLength: 2,
    includeScore: true,
    includeMatches: true,
  });

  // DOM elements
  const trigger = document.getElementById('search-trigger');
  const modal = document.getElementById('search-modal');
  const overlay = document.getElementById('search-overlay');
  const closeBtn = document.getElementById('search-close');
  const input = document.getElementById('search-input') as HTMLInputElement;
  const placeholder = document.getElementById('search-placeholder');
  const noResults = document.getElementById('search-no-results');
  const resultsGrid = document.getElementById('search-results-grid');
  const modalContent = document.querySelector('.search-modal-content');

  // Format date helper (client-side)
  function formatDate(dateString?: string): string {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  }

  // Escape HTML to prevent XSS
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Create HTML for a single search result
  function createResultElement(post: Post): HTMLElement {
    const article = document.createElement('article');
    article.className = 'search-result-item mb-6 transition px-4';

    let html = '';

    // Image
    // if (post.image) {
    //   html += `
    //     <div class="relative md:h-72 max-w-6xl mx-auto rounded drop-shadow-lg mb-6">
    //       <img 
    //         src="${escapeHtml(post.image)}" 
    //         alt="${escapeHtml(post.title)}" 
    //         class="object-contain md:h-full mb-6 rounded drop-shadow-lg w-full"
    //         loading="lazy"
    //         onerror="this.style.display='none'"
    //       />
    //     </div>
    //   `;
    // }

    // Content
    html += '<div>';
    html += '<header>';
    html += `
      <h2 class="text-xl sm:text-2xl leading-tight mb-2 font-subheading font-semibold">
        <a class="hover:text-primary transition ease-in duration-200" href="${escapeHtml(post.url)}">
          ${escapeHtml(post.title)}
        </a>
      </h2>
    `;
    
    if (post.publishDate) {
      html += `<i class="my-2 block">${escapeHtml(formatDate(post.publishDate))}</i>`;
    }
    
    html += '</header>';

    if (post.description) {
      html += `<div class="post-body body whitespace-pre-line">${escapeHtml(post.description)}</div>`;
    }

    html += '</div>';

    // Tags
    if (post.tags && post.tags.length > 0) {
      const tagItems = post.tags.slice(0, 5).map(tag => `
        <li class="bg-gray-100 dark:bg-slate-700 inline-block mr-2 mb-2 py-0.5 px-2 lowercase font-medium">
          <span class="text-muted dark:text-slate-300">${escapeHtml(tag)}</span>
        </li>
      `).join('');
      html += `<footer class="mt-2"><ul class="text-sm">${tagItems}</ul></footer>`;
    }

    article.innerHTML = html;
    return article;
  }

  // Focus trap variables
  let focusableElements: HTMLElement[] = [];
  let firstFocusableElement: HTMLElement | null = null;
  let lastFocusableElement: HTMLElement | null = null;

  function updateFocusableElements() {
    if (!modalContent) return;
    
    const focusableSelectors = 'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])';
    const elements = modalContent.querySelectorAll(focusableSelectors);
    focusableElements = Array.from(elements) as HTMLElement[];
    
    if (focusableElements.length > 0) {
      firstFocusableElement = focusableElements[0];
      lastFocusableElement = focusableElements[focusableElements.length - 1];
    }
  }

  function trapFocus(e: KeyboardEvent) {
    if (e.key !== 'Tab') return;
    
    if (focusableElements.length === 0) {
      e.preventDefault();
      return;
    }

    if (e.shiftKey) {
      // Shift + Tab
      if (document.activeElement === firstFocusableElement) {
        e.preventDefault();
        lastFocusableElement?.focus();
      }
    } else {
      // Tab
      if (document.activeElement === lastFocusableElement) {
        e.preventDefault();
        firstFocusableElement?.focus();
      }
    }
  }

  // Track if trapFocus is currently active
  let isTrapFocusActive = false;

  function openSearch() {
    modal?.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    updateFocusableElements();
    
    // Focus the first focusable element, or the modal itself if none exist
    if (firstFocusableElement) {
      firstFocusableElement.focus();
    } else if (modalContent) {
      (modalContent as HTMLElement).focus();
    }
    
    if (!isTrapFocusActive) {
      document.addEventListener('keydown', trapFocus);
      isTrapFocusActive = true;
    }
  }

  function closeSearch() {
    modal?.classList.add('hidden');
    document.body.style.overflow = '';
    if (input) input.value = '';
    clearResults();
    placeholder?.classList.remove('hidden');
    noResults?.classList.add('hidden');
    
    if (isTrapFocusActive) {
      document.removeEventListener('keydown', trapFocus);
      isTrapFocusActive = false;
    }
  }

  function clearResults() {
    if (resultsGrid) {
      resultsGrid.innerHTML = '';
    }
  }

  function showResults(results: Post[]) {
    clearResults();

    if (results.length === 0) {
      const searchTerm = input?.value || '';
      if (searchTerm.length >= 2) {
        placeholder?.classList.add('hidden');
        noResults?.classList.remove('hidden');
        if (noResults) {
          noResults.textContent = `No results found for "${searchTerm}"`;
        }
      } else {
        placeholder?.classList.remove('hidden');
        noResults?.classList.add('hidden');
      }
      return;
    }

    placeholder?.classList.add('hidden');
    noResults?.classList.add('hidden');

    // Render matching results (limit to 12)
    const fragment = document.createDocumentFragment();
    results.slice(0, 12).forEach(post => {
      fragment.appendChild(createResultElement(post));
    });
    
    resultsGrid?.appendChild(fragment);
    
    // Update focusable elements after rendering results
    updateFocusableElements();
  }

  function handleSearch() {
    const searchTerm = input?.value || '';

    if (searchTerm.length < 2) {
      clearResults();
      placeholder?.classList.remove('hidden');
      noResults?.classList.add('hidden');
      return;
    }

    // Use Fuse.js for fuzzy search
    const searchResults = fuse.search(searchTerm);
    const matchingPosts = searchResults.map(result => result.item);

    showResults(matchingPosts);
  }

  // Keyboard shortcut handler
  function handleKeyboardShortcuts(e: KeyboardEvent) {
    // Close on Escape key
    if (e.key === 'Escape' && !modal?.classList.contains('hidden')) {
      closeSearch();
      return;
    }
    
    // Keyboard shortcut (Cmd/Ctrl + K)
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      if (modal?.classList.contains('hidden')) {
        openSearch();
      } else {
        closeSearch();
      }
    }
  }

  // Cleanup function to remove all event listeners
  function cleanup() {
    trigger?.removeEventListener('click', openSearch);
    overlay?.removeEventListener('click', closeSearch);
    closeBtn?.removeEventListener('click', closeSearch);
    input?.removeEventListener('input', handleSearch);
    document.removeEventListener('keydown', handleKeyboardShortcuts);
    
    // Only remove trapFocus if it's currently active
    if (isTrapFocusActive) {
      document.removeEventListener('keydown', trapFocus);
      isTrapFocusActive = false;
    }
    
    // Remove lifecycle listeners
    document.removeEventListener('astro:before-preparation', cleanup);
    window.removeEventListener('beforeunload', cleanup);
  }

  // Initialize event listeners
  trigger?.addEventListener('click', openSearch);
  overlay?.addEventListener('click', closeSearch);
  closeBtn?.addEventListener('click', closeSearch);
  input?.addEventListener('input', handleSearch);
  document.addEventListener('keydown', handleKeyboardShortcuts);

  // Cleanup on page navigation (for Astro view transitions)
  document.addEventListener('astro:before-preparation', cleanup);
  
  // Cleanup on page unload (fallback for non-view-transition navigation)
  window.addEventListener('beforeunload', cleanup);
</script>
