---
/**
 * SupabaseImage Component
 * 
 * A flexible image component that supports both local Astro assets and Supabase Storage.
 * Automatically detects the image source and handles it appropriately.
 * 
 * @example Local image
 * ```astro
 * <SupabaseImage 
 *   src="/src/assets/images/logo.png" 
 *   alt="Logo" 
 *   width={200} 
 *   height={100} 
 * />
 * ```
 * 
 * @example Supabase image with path
 * ```astro
 * <SupabaseImage 
 *   src="posts/my-article.jpg" 
 *   alt="Article hero" 
 *   width={800} 
 *   height={600} 
 * />
 * ```
 * 
 * @example Supabase image with full URL
 * ```astro
 * <SupabaseImage 
 *   src="https://xxx.supabase.co/storage/v1/object/public/images/posts/hero.jpg" 
 *   alt="Hero" 
 *   width={1200} 
 *   height={630} 
 * />
 * ```
 * 
 * @example With transformations
 * ```astro
 * <SupabaseImage 
 *   src="posts/large-image.jpg" 
 *   alt="Optimized image"
 *   width={800}
 *   height={600}
 *   quality={80}
 *   format="webp"
 * />
 * ```
 */

import { Image } from 'astro:assets';
import { shouldUseSupabase, getSupabaseImageUrl } from '../../utils/supabase-images';
import { resolveImage } from '../../utils/image-loader';
import type { ImageMetadata } from 'astro';

interface Props {
  src: string | ImageMetadata;
  alt: string;
  width?: number;
  height?: number;
  quality?: number;
  format?: 'origin' | 'webp' | 'avif';
  resize?: 'cover' | 'contain' | 'fill';
  class?: string;
  loading?: 'lazy' | 'eager';
  decoding?: 'async' | 'sync' | 'auto';
  inferSize?: boolean;
  [key: string]: any; // Allow additional props to pass through
}

const {
  src,
  alt,
  width,
  height,
  quality,
  format,
  resize,
  class: className,
  loading = 'lazy',
  decoding = 'async',
  inferSize,
  ...rest
} = Astro.props;

// Resolve the image - convert local paths to ImageMetadata objects
const resolvedSrc = await resolveImage(src);

// Determine image type after resolution
// - ImageMetadata object: actual Astro import, use Image component with inferSize
// - String starting with '/src/': this shouldn't happen after resolution, but handle it
// - String (other): Supabase path or external URL
const isImageMetadata = typeof resolvedSrc !== 'string';
const isLocalStringPath = typeof resolvedSrc === 'string' && resolvedSrc.startsWith('/src/');
const useSupabase = typeof resolvedSrc === 'string' && !isLocalStringPath && shouldUseSupabase(resolvedSrc);

// For Supabase images, construct the URL with transformations
let imageSrc = resolvedSrc;
if (useSupabase && typeof resolvedSrc === 'string') {
  const transformOptions = {
    width,
    height,
    quality,
    format,
    resize,
  };
  imageSrc = getSupabaseImageUrl(resolvedSrc, transformOptions);
}
---

{isImageMetadata ? (
  <!-- ImageMetadata object - use native Image component with inferSize for automatic dimensions -->
  <Image
    src={resolvedSrc}
    alt={alt}
    width={width}
    height={height}
    class={className}
    loading={loading}
    decoding={decoding}
    inferSize={inferSize ?? true}
    {...rest}
  />
) : (
  <!-- Supabase path or external URL - use regular img tag -->
  <img
    src={imageSrc as string}
    alt={alt}
    width={width}
    height={height}
    class={className}
    loading={loading}
    decoding={decoding}
    {...rest}
  />
)}
